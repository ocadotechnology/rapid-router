{% extends 'game/base.html' %}

{% load static %}
{% load game.utils %}

{% block title %}Code for Life - Rapid Router - Scoreboard{% endblock %}

{% block scripts %}
    {{block.super}}
    <script src="{% static 'game/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'game/js/dataTables.fixedColumns.js' %}"></script>
    <script src="{% static 'game/js/jquery.tablesorter.js' %}"></script>
    <script src="{% static 'game/js/widget-scroller.js' %}"></script>
    <script src="{% static 'game/js/pqselect.min.js' %}"></script>
    <script src="{% static 'game/js/jquery.outerhtml.js' %}"></script>
    <script src="{% static 'game/js/scoreboard.js' %}"></script>
    <script>
        $(document).ready(function() {
            let scoreboardPresent = document.getElementById("scoreboardTable") !== null;
            let improvementPresent = document.getElementById("improvementTable") !== null;

            if (scoreboardPresent) {
                let table = $('#scoreboardTable').DataTable({
                    scrollY: false,
                    scrollX: true,
                    scrollCollapse: false,
                    paging: true,
                    deferRender: true,
                    language: {
                        emptyTable: 'No data available in table',
                        loadingRecords: 'Loading...',
                        processing: 'Processing...',
                        search: 'Search:',
                        zeroRecords: 'No matching records found',
                    },
                    columnDefs: [
                        {
                            orderable: false,
                            targets: "no-sort",
                        },
                    ],
                });

                new $.fn.dataTable.FixedColumns(table, {
                    leftColumns: 3,
                    rightColumns: 1,
                });
                document.getElementById("tableWrapper").scrollIntoView();

                $(".next").append(" >");
                $(".next").removeClass("paginate_button");

                $('#scoreboardSearch').on("keyup", function() {
                    table.search(this.value).draw();
                });

                table.on("draw", () => {
                    $(".next").append(" >");
                    $(".next").removeClass("paginate_button");
                    $(".previous").prepend("< ");
                    $(".previous").removeClass("paginate_button");
                });

                $(window).on('load', function() {
                    table.columns.adjust();
                });
            }

            // Stops closing the dropdowns when selecting items within it or when pressing the confirmation buttons
            $(document).on('click', '.dropdown .dropdown-menu', function (e) {
                e.stopPropagation();
            });

            if (improvementPresent) {
                const impTable = $('#improvementTable').DataTable({
                    pageLength: 5
                });

                impTable.on("draw", () => {
                    $(".next").append(" >");
                    $(".next").removeClass("paginate_button");
                    $(".previous").prepend("< ");
                    $(".previous").removeClass("paginate_button");
                });
            }
        });
    </script>
{% endblock %}

{% block css %}
{{block.super}}
    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/scoreboard.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/pqselect.min.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/pqselect.multiselect.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/jquery.dataTables.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/dataTables.fixedColumns.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/dataTables.jqueryui.css' %}" rel="stylesheet" type="text/css">
{% endblock %}

{% block header %}
<div class="banner banner--rapid-router--background row">
    <div class="level_rr_logo">
        <img title="Rapid Router logo" alt="Rapid Router logo" src="{% static 'game/image/RR_logo.svg' %}"></section>
    </div>
</div>
{% endblock header %}

{% block nav_ocargo_scoreboard %}
<a class="button button--secondary button--secondary" style="background-color: white; color: #fa1664;" href="{% url 'scoreboard' %}">Scoreboard</a>
{% endblock nav_ocargo_scoreboard %}

{% block content %}

<div class="container background">
    <h4 class="text-center">Scoreboard</h4>
    <form action="" method="post" id="scoreboardForm">
        {% csrf_token %}
        <div class="row form--row">
            <div class="form--row__input col-sm-2 col-md-2">
                <div class="input--icon">
                    <input type="text" name="Search" placeholder="Search" id="scoreboardSearch"><span class="iconify" data-icon="mdi:search"></span>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="dropdown">
                    <button class="button--secondary button--secondary--dark button--dropdown" data-toggle="dropdown" aria-expanded="false">
                        <div class="dropdown__text">Filter classes</div>
                    </button>
                    <ul class="dropdown-menu">
                        <li class="dropdown-menu__option">
                            <a class="button button--regular">
                                <p class="dropdown-menu__option__text">
                                    <label for="select-all-classes">
                                        <input type="checkbox" id="select-all-classes"><strong>Select all</strong>
                                    </label>
                                </p>
                            </a>
                        </li>
                        {% for class in form.classes %}
                            <li class="dropdown-menu__option">
                                <a class="button button--regular">
                                    <p class="dropdown-menu__option__text">{{ class }}</p>
                                </a>
                            </li>
                        {% endfor %}
                        <div class="row">
                            <div class="col-sm-6 text-right">
                                <a class="button button--secondary button--secondary--dark" id="clear-classes">Clear</a>
                            </div>
                            <div class="col-sm-6 text-left">
                                <button class="button button--primary" type="submit" name="view">Save</button>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="dropdown">
                    <button class="button--secondary button--secondary--dark button--dropdown" data-toggle="dropdown" aria-expanded="false">
                        <div class="dropdown__text">Filter levels</div>
                    </button>
                    <ul class="dropdown-menu">
                        <li class="dropdown-menu__option">
                            <a class="button button--regular">
                                <p class="dropdown-menu__option__text">
                                    <label for="select-all-levels">
                                        <input type="checkbox" id="select-all-levels"><strong>Select all</strong>
                                    </label>
                                </p>
                            </a>
                        </li>
                        {% for episode in form.episodes %}
                            <li class="dropdown-menu__option">
                                <a class="button button--regular">
                                    <p class="dropdown-menu__option__text">{{ episode }}</p>
                                </a>
                            </li>
                        {% endfor %}
                        <div class="row">
                            <div class="col-sm-offset-4 col-sm-4">
                                <a class="button button--secondary button--secondary--dark" id="clear-levels">Clear</a>
                            </div>
                            <div class="col-sm-4">
                                <button class="button button--primary" type="submit" name="view">Save</button>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <h5>Progress</h5>
        <p>The table below shows progress your students are making. The traffic light system is designed to highlight peaks
            and troughs in level performance.
        </p>
        <div class="background tableWrapper" id="tableWrapper">
            {% if student_data %}
                <div class="dataTables_info" id="scoreboardTable_info" role="status" aria-live="polite"></div>
                <table id="scoreboardTable" class="display cell-border wide header-primary data-primary">
                    <thead>
                    <tr>
                        {% for header in headers %}
                            <th class="fixed-width">{{ header }}</th>
                        {% endfor %}
                        {% for level_header in level_headers %}
                            <th class="no-sort text-center">{{ level_header }}</th>
                        {% endfor %}
                        <th class="fixed-width">{{ total_points_header }}</th>
                    </tr>
                    </thead>
                    {% for student in student_data %}
                        <tr>
                            <td class="fixed-width">{{ student.class_field }}</td>
                            <td class="fixed-width">{{ student.name }}</td>
                            <td>{{ student.completed }}</td>
                            <td>{{ student.total_time }}</td>
                            {% for level_id, level_score in student.level_scores.items %}
                                {% if level_score.full_score %}
                                    <td class="text-center scoreboard--completed">
                                        <div class="d-flex justify-content-center">
                                            <span class="iconify" data-icon="mdi:star"></span>
                                        </div>
                                    </td>
                                {% elif level_score.is_low_attempt %}
                                    <td class="text-center scoreboard--started">{{ level_score.score }}</td>
                                {% else %}
                                    <td class="text-center">{{ level_score.score }}</td>
                                {% endif %}
                            {% endfor %}
                            {% if student.percentage_complete > 75 %}
                                <td class="scoreboard--top-performer">{{ student.total_score }}</td>
                            {% elif student.percentage_complete < 33 %}
                                <td class="scoreboard--started">{{ student.total_score }}</td>
                            {% else %}
                                <td class="scoreboard--medium-performer">{{ student.total_score }}</td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                </table>
            {% endif %}
        </div>
    </form>
</div>

<div class="container background alternative-section">
    <h5>Areas for improvement</h5>
    <p>The table below shows areas that could need improvement.</p>

    <div class="background tableWrapper" id="tableWrapper">
        {% if student_data %}
            <div class="dataTables_info" role="status" aria-live="polite"></div>
            <table id="improvementTable" class="display cell-border wide header-primary data-primary">
                <thead>
                <tr>
                    <th class="fixed-width">Class</th>
                    <th class="fixed-width">Student</th>
                    <th>Areas of concern</th>
                </tr>
                </thead>
                {% for student in improvement_data %}
                    <tr>
                        <td class="fixed-width">{{ student.class_field }}</td>
                        <td class="fixed-width">{{ student.name }}</td>
                        <td>{{ student.areas }}</td>
                    </tr>
                {% endfor %}
            </table>
            <div class="text-right mt-4">
                <button class="button button--primary button--icon m-0" type="submit" name="export">
                    Export results
                    <span class="iconify" data-icon="mdi:tray-arrow-down"></span>
                </button>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

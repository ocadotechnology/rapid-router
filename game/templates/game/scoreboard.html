{% extends 'game/base.html' %}

{% load static %}
{% load i18n %}
{% load l10n %}
{% load game.utils %}

{% block title %}Code for Life - Rapid Router - Scoreboard{% endblock %}

{% block scripts %}
    {{block.super}}
    <script src="{% static 'game/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'game/js/dataTables.fixedColumns.js' %}"></script>
    <script src="{% static 'game/js/jquery.tablesorter.js' %}"></script>
    <script src="{% static 'game/js/widget-scroller.js' %}"></script>
    <script src="{% static 'game/js/pqselect.min.js' %}"></script>
    <script src="{% static 'game/js/jquery.outerhtml.js' %}"></script>
    <script src="{% static 'game/js/jquery.ui.multiprogressbar.js' %}"></script>
    <script src="{% static 'game/js/scoreboard.js' %}"></script>
    <script>
        $(document).ready(function() {
            // Initialise progress values for each progress bar
            {# Only initialise progress bars if the column exists #}
            {% if 'Progress' in headers %}
                {% for student in student_data %}
                    let id = {{ student.id }};
                    {% localize off %}
                        let started = {{ student.progress.0 }};
                        let attempted = {{ student.progress.1 }};
                        let finished = {{ student.progress.2 }};
                    {% endlocalize %}
                    $('#progressbar' + id).multiprogressbar({
                        parts: [{value: started, barClass: 'started'},
                            {value: attempted, barClass: 'attempted'},
                            {value: finished, barClass: 'finished'}],
                    });
                {% endfor %}
            {% endif %}

            let scoreboardPresent = document.getElementById("scoreboardTable") !== null;

            if (scoreboardPresent) {
                let table = $('#scoreboardTable').DataTable({
                    scrollY: false,
                    scrollX: true,
                    scrollCollapse: false,
                    paging: true,
                    deferRender: true,
                    language: {
                        emptyTable: '{% trans 'No data available in table' %}',
                        info: '{% blocktrans with start='_START_' end='_END_' total='_TOTAL_' %}Showing {{ start }} to {{ end }} of {{ total }} entries{% endblocktrans %}',
                        infoEmpty: '{% blocktrans with start='0' end='0' total='0' %}Showing {{ start }} to {{ end }} of {{ total }} entries{% endblocktrans %}',
                        infoFiltered: '{% blocktrans with max='_MAX_' %}(filtered from {{ max }} total entries){% endblocktrans %}',
                        loadingRecords: '{% trans 'Loading...' %}',
                        processing: '{% trans 'Processing...' %}',
                        search: '{% trans 'Search:' %}',
                        zeroRecords: '{% trans 'No matching records found' %}'
                    },
                });

                new $.fn.dataTable.FixedColumns(table, {
                    leftColumns: 3,
                    rightColumns: 1,
                });
                document.getElementById("tableWrapper").scrollIntoView();

                $(".next").append(" >");
                $(".next").removeClass("paginate_button");

                $('#scoreboardSearch').on("keyup", function() {
                    table.search(this.value).draw();
                });

                table.on("draw", () => {
                    $(".next").append(" >");
                    $(".next").removeClass("paginate_button");
                    $(".previous").prepend("< ");
                    $(".previous").removeClass("paginate_button");
                });
            }
        });
    </script>
{% endblock %}

{% block css %}
{{block.super}}
    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/scoreboard.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/pqselect.min.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/pqselect.multiselect.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/jquery.ui.multiprogressbar.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/jquery.dataTables.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/dataTables.fixedColumns.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'game/css/dataTables.jqueryui.css' %}" rel="stylesheet" type="text/css">
{% endblock %}

{% block nav_ocargo_scoreboard %}
<a class="button button--secondary button--secondary" style="background-color: white; color: #fa1664;" href="{% url 'scoreboard' %}">{% trans "Scoreboard" %}</a>
{% endblock nav_ocargo_scoreboard %}

{% block content %}
<div class="container">
    <h4 class="text-center">{% trans "Scoreboard" %}</h4>
    <p>The table below shows progress your students are making. The traffic light system is designed to highlight peaks
        and troughs in level performance.</p>

    <form action="" method="post" id="scoreboardForm">
        {% csrf_token %}
        <div class="row form--row">
            <div class="form--row__input col-sm-2 col-md-2">
                <div class="input--icon">
                    <input type="text" name="Search" placeholder="Search" id="scoreboardSearch"><span class="iconify" data-icon="mdi:search"></span>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="dropdown">
                    <button class="button--secondary button--secondary--dark button--dropdown" data-toggle="dropdown" aria-expanded="false">
                        <div class="dropdown__text">Filter classes</div>
                    </button>
                    <ul class="dropdown-menu">
                        {% for class in form.classes %}
                            <li class="dropdown-menu__option">
                                <a class="button button--regular">
                                    <p class="dropdown-menu__option__text">{{ class }}</p>
                                </a>
                            </li>
                        {% endfor %}
                        <div class="row">
                            <div class="col-sm-6 text-right">
                                <button class="button button--secondary button--secondary--dark">Clear</button>
                            </div>
                            <div class="col-sm-6 text-left">
                                <button class="button button--primary" type="submit" name="view">Save</button>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="dropdown">
                    <button class="button--secondary button--secondary--dark button--dropdown" data-toggle="dropdown" aria-expanded="false">
                        <div class="dropdown__text">Filter levels</div>
                    </button>
                    <ul class="dropdown-menu">
                        {% for episode in form.episodes %}
                            <li class="dropdown-menu__option">
                                <a class="button button--regular">
                                    <p class="dropdown-menu__option__text">{{ episode }}</p>
                                </a>
                            </li>
                        {% endfor %}
                        <div class="row">
                            <div class="col-sm-offset-4 col-sm-4">
                                <button class="button button--secondary button--secondary--dark">Clear</button>
                            </div>
                            <div class="col-sm-4">
                                <button class="button button--primary" type="submit" name="view">Save</button>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="background container mainBody">
    <div class="tableWrapper" id="tableWrapper">
    {% if student_data %}
        <div class="dataTables_info" id="scoreboardTable_info" role="status" aria-live="polite"></div>
        <table id="scoreboardTable" class="display cell-border wide header-primary data-primary">
        <thead>
            <tr>
                {% for header in headers %}
                    <th {% if header == progress_header %} title="{% trans 'Colours explained:&#013;Red: Number of levels which student has started but not submitted a working solution &#013;Orange: Number of levels which student has scored below 50% &#013;Green: Number of levels which student has scored above 50%' %}"{% endif %}> {{header}} </th>
                {% endfor %}
                <th>{{ total_points_header }}</th>
            </tr>
        </thead>
        {% for student in student_data %}
            <tr>
                <td> {{student.class_field}} </td>
                <td> {{student.name}} </td>
                <td> {{student.completed }}</td>
                <td> {{student.total_time}}
                {% for levelScore in student.scores %}
                    {# Levels that students have not started will be marked with grey colour #}
                    <td > {{levelScore}} </td>
                {% endfor %}
                <td> {{student.total_score}} </td>
            </tr>
        {% endfor %}
        </table>
    {% endif %}
    </div>
</div>
{% endblock %}
